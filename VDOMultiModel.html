import React, { useState, useCallback, useEffect, useRef } from 'react';

// --- Constants & Options ---
const API_KEY = ""; 
const MAX_RETRIES = 6;

// 1. Camera Movement Options (Top 6 first)
const CAMERA_MOVEMENT_OPTIONS = [
    "Slow dolly in", "Slow dolly out", "Orbit 180 (Half circle)", "Slow cinematic arc", 
    "Drone flyover (High altitude)", "Handheld documentary style", 
    "Dolly Zoom (Vertigo Effect)", "360 Degree Pan", "Crane Shot / Jib Shot", 
    "Dolly In / Out", "Static Shot", "Point of View (POV)", "Hyper zoom", 
    "Reveal from behind", "Through shot", "Tilt Up/Down", "Lateral truck", 
    "Fast 360 orbit", "FPV drone dive", "Whip pan", "Dutch angle roll", 
    "Following shot", "Side tracking"
];

// 2. Lighting Options
const LIGHTING_OPTIONS = [
    "Volumetric Lighting / God Rays", "Golden Hour / Blue Hour", "Rim Lighting / Edge Lighting",
    "Cyberpunk / Neon Noir", "High Contrast / Chiaroscuro", "Softbox / Studio Lighting",
    "Diffused lighting", "Silhouette", "Lens flare", "Back lit / Side lit",
    "Color gel lighting", "Venetian lighting"
];

// 3. Technical Effects Options
const TECHNICAL_OPTIONS = [
    "Fluid Dynamics", "Particles / Dust Motes", "Motion Blur", 
    "Slow-motion (120fps)", "Slow-motion (240fps)", "Morphing / Seamless Transition",
    "Shallow Depth of Field (Bokeh)", "Deep Depth of Field", "Fast Zoom Effect",
    "8k Resolution", "Hyper-realistic textures", "Physically accurate motion"
];

// 4. Voice Style Options (Top 6)
const VOICE_OPTIONS = [
    "Professional Narration", "Energetic & Upbeat", "Calm & Soothing",
    "Dramatic Movie Trailer", "Casual Vlogger Style", "Deep Emotional / Heartfelt"
];

// 5. Sound Style Options (Top 6)
const SOUND_OPTIONS = [
    "Epic Cinematic Orchestral", "Cyberpunk Synthwave", "Ambient Nature / Wildlife",
    "Urban City Ambience", "Lo-fi Chill Beats", "Suspenseful / Dark Thriller"
];

// --- System Instructions ---

const buildSystemPrompt = (modelName, baseInstruction) => `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç ${modelName}.
‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: ‡∏™‡∏£‡πâ‡∏≤‡∏á 12 ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏û‡∏£‡∏≠‡∏°‡∏ï‡πå‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á: [Camera Movement] + [Subject/Action] + [Environment/Style] + [Lighting] + [Technical Quality] + [Sound/Voice Style]
‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: 
- ‡∏ô‡∏≥ "Camera Movements", "Lighting", "Technical Qualities", "Voice Style" ‡πÅ‡∏•‡∏∞ "Sound Style" ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
- ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Veo3 ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Timeline 0-8 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ: 1. SECOND 0-2: [‡∏â‡∏≤‡∏Å/‡πÄ‡∏™‡∏µ‡∏¢‡∏á]. 2. SECOND 2-4: [‡∏â‡∏≤‡∏Å/‡πÄ‡∏™‡∏µ‡∏¢‡∏á]. 3. SECOND 4-6: [‡∏â‡∏≤‡∏Å/‡πÄ‡∏™‡∏µ‡∏¢‡∏á]. 4. SECOND 6-8: [‡∏â‡∏≤‡∏Å/‡πÄ‡∏™‡∏µ‡∏¢‡∏á]. Sound throughout: [‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å]
- ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏ó‡∏∏‡∏Å‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏•‡∏•‡∏∑‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏ó‡∏£‡∏á‡∏û‡∏•‡∏±‡∏á
${baseInstruction}
Return JSON: { "prompts": [{ "prompt": string, "summary_th": string }] } (12 items).`;

const SYSTEM_PROMPTS = {
    wan: buildSystemPrompt("WAN 2.1 Video AI", "‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏ó‡∏≤‡∏á‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏"),
    kling: buildSystemPrompt("KLING 2.6", "‡πÄ‡∏ô‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏ó‡∏µ‡πà‡∏≠‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏ö‡∏ö"),
    seedance: buildSystemPrompt("Seedance 1.5 Pro", "‡πÄ‡∏ô‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÅ‡∏•‡∏∞‡∏™‡πÑ‡∏ï‡∏•‡πå Hybrid AI"),
    grok: buildSystemPrompt("Grok's Imagine Video", "‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®‡πÅ‡∏ö‡∏ö Cyberpunk/Tech"),
    veo: buildSystemPrompt("Veo3 (0-8s Timeline)", `‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏õ‡πä‡∏∞‡πÜ ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏∏: 1. SECOND 0-2: [Description]. 2. SECOND 2-4: [Description]. 3. SECOND 4-6: [Description]. 4. SECOND 6-8: [Description]. Sound throughout: [Description]`),
    story: buildSystemPrompt("Story Mode", "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå 12 ‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ö‡∏ó‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå")
};

const SYSTEM_PROMPT_TRANSLATE = `‡πÅ‡∏õ‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÇ‡∏î‡∏¢‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏®‡∏±‡∏û‡∏ó‡πå‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÑ‡∏ß‡πâ ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢`;
const SYSTEM_PROMPT_SOUND = `‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏û‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°`;

const JSON_SCHEMA = {
  type: "OBJECT",
  properties: {
    "prompts": {
      "type": "ARRAY",
      "items": {
        "type": "OBJECT",
        "properties": {
          "prompt": { "type": "STRING" },
          "summary_th": { "type": "STRING" }
        },
        "required": ["prompt", "summary_th"]
      }
    }
  },
  required: ["prompts"]
};

// --- Helper Functions ---
const getApiUrl = () => `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

const fetchWithBackoff = async (url, options) => {
  let retries = 0;
  while (retries < MAX_RETRIES) {
    try {
      const response = await fetch(url, options);
      if (response.ok) return response;
      if (response.status === 429) {
        await new Promise(r => setTimeout(r, 30000));
        retries++; continue;
      }
      throw new Error(`API Error: ${response.status}`);
    } catch (e) {
      if (retries === MAX_RETRIES - 1) throw e;
      await new Promise(r => setTimeout(r, Math.pow(2, retries) * 1000));
      retries++;
    }
  }
};

const copyToClipboard = (text) => {
  const el = document.createElement('textarea');
  el.value = text;
  document.body.appendChild(el);
  el.select();
  document.execCommand('copy');
  document.body.removeChild(el);
};

// --- Components ---

const Icon = ({ name, className }) => {
    const icons = {
        copy: <path d="M8 2h12a2 2 0 0 1 2 2v12m-4 4H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2Z"/>,
        magic: (
            <>
                <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/>
                <path d="M5 3v4m4-2H3m15 14v4m4-2h-6"/>
            </>
        ),
        sound: (
            <>
                <path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>
            </>
        ),
        trash: (
            <>
                <path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </>
        ),
        globe: (
            <>
                <circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1 4-10z"/>
            </>
        ),
        camera: (
            <>
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/>
            </>
        )
    };
    return (
        <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            {icons[name] || <circle cx="12" cy="12" r="10" />}
        </svg>
    );
};

export default function App() {
    const [images, setImages] = useState([]);
    const [results, setResults] = useState(() => {
        const saved = localStorage.getItem('rahupower_v5_final');
        return saved ? JSON.parse(saved) : [];
    });
    const [loading, setLoading] = useState(false);
    const [keywords, setKeywords] = useState("");
    const [negPrompt, setNegPrompt] = useState("distorted, blurry, text, watermark, low quality, bad anatomy, deformed, yellow, gold");
    const [model, setModel] = useState('wan');
    const [motion, setMotion] = useState(6);
    const [aspect, setAspect] = useState("16:9");
    const [selectedMovements, setSelectedMovements] = useState([]);
    const [selectedLighting, setSelectedLighting] = useState([]);
    const [selectedTechnical, setSelectedTechnical] = useState([]);
    const [selectedVoice, setSelectedVoice] = useState([]);
    const [selectedSound, setSelectedSound] = useState([]);
    const [translations, setTranslations] = useState({});
    const [sounds, setSounds] = useState({});

    useEffect(() => { localStorage.setItem('rahupower_v5_final', JSON.stringify(results)); }, [results]);

    const handleUpload = async (e) => {
        const files = Array.from(e.target.files);
        const processed = await Promise.all(files.map(async f => ({
            name: f.name,
            type: f.type,
            url: URL.createObjectURL(f),
            b64: await new Promise(res => {
                const r = new FileReader();
                r.readAsDataURL(f);
                r.onload = () => res(r.result.split(',')[1]);
            })
        })));
        setImages(prev => [...prev, ...processed]);
    };

    const toggleSelection = (item, state, setter, max = 3) => {
        setter(prev => {
            if (prev.includes(item)) return prev.filter(i => i !== item);
            if (prev.length >= max) return prev;
            return [...prev, item];
        });
    };

    const generate = async () => {
        if (!images.length) return;
        setLoading(true);
        const newRes = [];

        for (const img of images) {
            const sys = SYSTEM_PROMPTS[model] || SYSTEM_PROMPTS.wan;
            
            const selectionContext = `
              - CAMERA MOVEMENTS: ${selectedMovements.join(', ') || 'Auto'}
              - LIGHTING: ${selectedLighting.join(', ') || 'Auto'}
              - TECHNICAL: ${selectedTechnical.join(', ') || 'Auto'}
              - VOICE STYLE: ${selectedVoice.join(', ') || 'Auto'}
              - SOUND STYLE: ${selectedSound.join(', ') || 'Auto'}
            `;

            const fullPrompt = `${sys}\n\nTheme: ${keywords}\nUser Selection Context:\n${selectionContext}\nMotion: ${motion}/10\nNegative: ${negPrompt}`;

            try {
                const response = await fetchWithBackoff(getApiUrl(), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        systemInstruction: { parts: [{ text: fullPrompt }] },
                        contents: [{ role: "user", parts: [
                            { inlineData: { mimeType: img.type, data: img.b64 } },
                            { text: "‡∏™‡∏£‡πâ‡∏≤‡∏á 12 ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏û‡∏£‡∏≠‡∏°‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏ö‡∏ö‡∏ï‡∏≤‡∏°‡∏û‡∏•‡πá‡∏≠‡∏ï‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î" }
                        ]}],
                        generationConfig: { responseMimeType: "application/json", responseSchema: JSON_SCHEMA }
                    })
                });
                const data = await response.json();
                const promptsText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (promptsText) {
                    const prompts = JSON.parse(promptsText).prompts;
                    newRes.push({ 
                        id: Date.now() + Math.random(), 
                        img: img.url, 
                        name: img.name, 
                        prompts, 
                        model, 
                        meta: {
                            movements: [...selectedMovements],
                            lighting: [...selectedLighting],
                            voice: [...selectedVoice],
                            sound: [...selectedSound]
                        }
                    });
                }
            } catch (e) {
                console.error("Generation failed:", img.name, e);
            }
        }
        setResults(prev => [...newRes, ...prev]);
        setLoading(false);
        setImages([]);
    };

    const action = async (type, text, id) => {
        let sys = type === 'trans' ? SYSTEM_PROMPT_TRANSLATE : SYSTEM_PROMPT_SOUND;
        try {
            const res = await fetchWithBackoff(getApiUrl(), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    systemInstruction: { parts: [{ text: sys }] },
                    contents: [{ parts: [{ text }] }]
                })
            });
            const data = await res.json();
            const output = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (type === 'trans') setTranslations(prev => ({ ...prev, [id]: output }));
            else setSounds(prev => ({ ...prev, [id]: output }));
        } catch (e) {
            console.error(e);
        }
    };

    return (
        <div className="min-h-screen bg-[#F8FAFC] text-[#1E293B] p-4 md:p-8 font-sans selection:bg-[#66FCF1]/50">
            <div className="max-w-6xl mx-auto space-y-8">
                
                <header className="text-center space-y-4 py-6 relative">
                    <div className="absolute inset-0 bg-gradient-to-b from-[#0891B2]/10 to-transparent blur-3xl -z-10"></div>
                    <h1 className="text-5xl font-black bg-gradient-to-r from-[#0891B2] via-[#DB2777] to-[#475569] bg-clip-text text-transparent tracking-tighter drop-shadow-sm">
                        GYMMATEX: MULTIMODAL MASTER
                    </h1>
                    <div className="flex flex-wrap items-center justify-center gap-3">
                        {['WAN 2.1', 'KLING 2.6', 'SEEDANCE', 'GROK', 'VEO3', 'STORY'].map(tag => (
                            <span key={tag} className="px-3 py-1 rounded-md bg-white border border-slate-200 text-[10px] font-bold text-[#0891B2] uppercase tracking-[0.2em] shadow-sm">{tag}</span>
                        ))}
                    </div>
                </header>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div className="lg:col-span-2 space-y-6">
                        {/* 1. Subject & Story */}
                        <div className="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm space-y-6">
                            <div className="flex items-center justify-between">
                                <div className="space-y-1">
                                    <label className="text-xs font-black text-[#0891B2] uppercase tracking-[0.3em]">1. Subject & Plot</label>
                                    <p className="text-xs text-slate-400 italic font-medium">‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏•‡πá‡∏≠‡∏ï‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏û‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö</p>
                                </div>
                                <input type="file" multiple onChange={handleUpload} className="hidden" id="upload" />
                                <label htmlFor="upload" className="cursor-pointer bg-[#0891B2] hover:bg-[#0E7490] text-white px-8 py-3 rounded-xl text-xs font-black transition-all shadow-md active:scale-95">
                                    + ADD IMAGES
                                </label>
                            </div>
                            
                            <div className="flex gap-4 overflow-x-auto pb-4 scrollbar-hide min-h-[80px]">
                                {images.map((img, i) => (
                                    <img key={i} src={img.url} className="h-20 w-20 rounded-xl object-cover ring-2 ring-slate-100 shadow-sm" />
                                ))}
                                {images.length === 0 && <div className="w-full border-2 border-dashed border-slate-100 rounded-2xl flex items-center justify-center text-slate-300 text-xs font-medium uppercase py-6 bg-slate-50">Awaiting input...</div>}
                            </div>

                            <textarea 
                                value={keywords} 
                                onChange={e => setKeywords(e.target.value)}
                                className="w-full bg-slate-50 border border-slate-100 rounded-2xl p-6 text-sm focus:ring-2 focus:ring-[#0891B2]/20 focus:border-[#0891B2]/50 outline-none h-24 transition-all"
                                placeholder="‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏û‡∏•‡πá‡∏≠‡∏ï‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡πâ‡∏ô..."
                            />
                        </div>

                        {/* Modular Selection Grid */}
                        <div className="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm space-y-8">
                            {/* Camera Movements */}
                            <div className="space-y-4">
                                <label className="text-xs font-black text-[#DB2777] uppercase tracking-[0.2em]">2. Camera Movements (Max 3)</label>
                                <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
                                    {CAMERA_MOVEMENT_OPTIONS.map((move, idx) => (
                                        <button
                                            key={move}
                                            onClick={() => toggleSelection(move, selectedMovements, setSelectedMovements)}
                                            className={`text-[9px] text-left px-3 py-2 rounded-lg border transition-all ${
                                                selectedMovements.includes(move)
                                                ? 'bg-[#0891B2] border-[#0891B2] text-white font-bold' 
                                                : idx < 6 ? 'bg-cyan-50 border-cyan-100 text-[#0891B2]' : 'bg-white border-slate-100 text-slate-400'
                                            }`}
                                        >
                                            {idx < 6 && "üî• "}{move}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Lighting Selection */}
                            <div className="space-y-4">
                                <label className="text-xs font-black text-[#0891B2] uppercase tracking-[0.2em]">3. Cinematic Lighting (Max 2)</label>
                                <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
                                    {LIGHTING_OPTIONS.map(light => (
                                        <button
                                            key={light}
                                            onClick={() => toggleSelection(light, selectedLighting, setSelectedLighting, 2)}
                                            className={`text-[9px] text-left px-3 py-2 rounded-lg border transition-all ${
                                                selectedLighting.includes(light)
                                                ? 'bg-[#0891B2] border-[#0891B2] text-white font-bold' 
                                                : 'bg-white border-slate-100 text-slate-400'
                                            }`}
                                        >
                                            {light}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* New: Voice Style Selection */}
                            <div className="space-y-4">
                                <label className="text-xs font-black text-[#475569] uppercase tracking-[0.2em]">4. Voice Style (Max 1)</label>
                                <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                    {VOICE_OPTIONS.map(v => (
                                        <button
                                            key={v}
                                            onClick={() => toggleSelection(v, selectedVoice, setSelectedVoice, 1)}
                                            className={`text-[9px] text-left px-3 py-2 rounded-lg border transition-all ${
                                                selectedVoice.includes(v)
                                                ? 'bg-slate-800 border-slate-800 text-white font-bold' 
                                                : 'bg-white border-slate-100 text-slate-400'
                                            }`}
                                        >
                                            üéôÔ∏è {v}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* New: Sound Style Selection */}
                            <div className="space-y-4">
                                <label className="text-xs font-black text-[#475569] uppercase tracking-[0.2em]">5. Sound Style (Max 1)</label>
                                <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                    {SOUND_OPTIONS.map(s => (
                                        <button
                                            key={s}
                                            onClick={() => toggleSelection(s, selectedSound, setSelectedSound, 1)}
                                            className={`text-[9px] text-left px-3 py-2 rounded-lg border transition-all ${
                                                selectedSound.includes(s)
                                                ? 'bg-slate-800 border-slate-800 text-white font-bold' 
                                                : 'bg-white border-slate-100 text-slate-400'
                                            }`}
                                        >
                                            üéµ {s}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Technical Effects */}
                            <div className="space-y-4">
                                <label className="text-xs font-black text-slate-400 uppercase tracking-[0.2em]">6. Technical Quality (Max 2)</label>
                                <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
                                    {TECHNICAL_OPTIONS.map(tech => (
                                        <button
                                            key={tech}
                                            onClick={() => toggleSelection(tech, selectedTechnical, setSelectedTechnical, 2)}
                                            className={`text-[9px] text-left px-3 py-2 rounded-lg border transition-all ${
                                                selectedTechnical.includes(tech)
                                                ? 'bg-slate-200 border-slate-300 text-slate-800 font-bold' 
                                                : 'bg-white border-slate-100 text-slate-400'
                                            }`}
                                        >
                                            {tech}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Sidebar: Engine & Advanced Config */}
                    <div className="space-y-6">
                        <div className="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm space-y-6 h-fit sticky top-8">
                            <label className="text-xs font-black text-[#0891B2] uppercase tracking-[0.3em]">AI Engine</label>
                            <div className="grid grid-cols-2 gap-2">
                                {Object.keys(SYSTEM_PROMPTS).map(m => (
                                    <button 
                                        key={m} 
                                        onClick={() => setModel(m)}
                                        className={`py-3 rounded-xl text-[10px] font-black uppercase border transition-all ${model === m ? 'bg-[#0891B2] border-[#0891B2] text-white shadow-md' : 'bg-slate-50 border-slate-100 text-slate-400 hover:text-slate-600'}`}
                                    >
                                        {m}
                                    </button>
                                ))}
                            </div>

                            <div className="space-y-4 pt-4 border-t border-slate-50">
                                <div className="space-y-2">
                                    <label className="text-[10px] font-bold text-slate-400 uppercase">Aspect Ratio</label>
                                    <select value={aspect} onChange={e => setAspect(e.target.value)} className="w-full bg-slate-50 border border-slate-100 rounded-xl p-3 text-xs font-bold outline-none">
                                        <option>16:9</option><option>9:16</option><option>21:9</option><option>1:1</option>
                                    </select>
                                </div>
                                <div className="space-y-2">
                                    <label className="text-[10px] font-bold text-slate-400 uppercase flex justify-between">Motion <span>{motion}/10</span></label>
                                    <input type="range" min="1" max="10" value={motion} onChange={e => setMotion(e.target.value)} className="w-full accent-[#0891B2] h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer" />
                                </div>
                            </div>

                            <button 
                                onClick={generate} 
                                disabled={loading || !images.length}
                                className="w-full bg-gradient-to-r from-[#0891B2] to-[#0E7490] py-6 rounded-2xl font-black text-xs text-white shadow-lg shadow-[#0891B2]/20 hover:scale-[1.02] active:scale-95 transition-all disabled:opacity-30 disabled:grayscale"
                            >
                                {loading ? "PREPARING PIPELINE..." : "START GENERATION"}
                            </button>
                        </div>
                    </div>
                </div>

                {/* Results Section */}
                <div className="space-y-8 pb-20">
                    {results.length > 0 && (
                        <div className="flex items-center justify-between border-b border-slate-100 pb-4">
                            <h2 className="text-xl font-black text-slate-700 uppercase italic">Recent Archives</h2>
                            <button onClick={() => setResults([])} className="text-[10px] font-bold text-[#DB2777] uppercase tracking-widest flex items-center gap-2">
                                <Icon name="trash" className="w-4 h-4" /> Clear All
                            </button>
                        </div>
                    )}
                    {results.map(res => (
                        <div key={res.id} className="bg-white rounded-[2.5rem] border border-slate-100 overflow-hidden shadow-sm">
                            <div className="p-6 bg-slate-50/50 border-b border-slate-100 flex flex-wrap items-center justify-between gap-6">
                                <div className="flex items-center gap-6">
                                    <img src={res.img} className="h-16 w-16 rounded-2xl object-cover shadow-sm ring-4 ring-white" />
                                    <div>
                                        <h3 className="font-black text-slate-800">{res.name}</h3>
                                        <div className="flex flex-wrap gap-2 mt-1">
                                            <span className="text-[8px] font-black text-white bg-[#0891B2] px-2 py-0.5 rounded uppercase">{res.model}</span>
                                            {res.meta.movements.map(m => <span key={m} className="text-[8px] font-bold text-slate-400 bg-white border border-slate-100 px-2 py-0.5 rounded">{m}</span>)}
                                            {res.meta.voice.map(v => <span key={v} className="text-[8px] font-bold text-[#0891B2] bg-white border border-[#0891B2]/20 px-2 py-0.5 rounded">üéôÔ∏è {v}</span>)}
                                        </div>
                                    </div>
                                </div>
                                <button onClick={() => setResults(prev => prev.filter(r => r.id !== res.id))} className="w-10 h-10 flex items-center justify-center rounded-xl bg-white text-slate-300 hover:text-red-500 border border-slate-100 transition-all shadow-sm">
                                    <Icon name="trash" className="w-5 h-5" />
                                </button>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 p-8">
                                {res.prompts.map((p, i) => {
                                    const pid = `${res.id}-${i}`;
                                    const finalPrompt = `${p.prompt} --ar ${aspect} --motion ${motion}${negPrompt ? ` --no ${negPrompt}` : ''}`;
                                    return (
                                        <div key={i} className="group relative bg-white border border-slate-100 rounded-[2rem] p-6 hover:bg-slate-50 transition-all shadow-sm">
                                            <div className="flex items-center justify-between mb-4">
                                                <span className="text-[9px] bg-[#0891B2]/5 text-[#0891B2] px-3 py-1 rounded-lg font-black uppercase tracking-widest">{p.summary_th}</span>
                                                <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-all">
                                                    <button onClick={() => action('trans', p.prompt, pid)} className="p-2 bg-white rounded-lg border border-slate-100 text-slate-400 hover:text-[#0891B2] shadow-sm"><Icon name="globe" className="w-4 h-4" /></button>
                                                    <button onClick={() => action('sound', p.prompt, pid)} className="p-2 bg-white rounded-lg border border-slate-100 text-slate-400 hover:text-[#DB2777] shadow-sm"><Icon name="sound" className="w-4 h-4" /></button>
                                                    <button onClick={() => copyToClipboard(finalPrompt)} className="p-2 bg-white rounded-lg border border-slate-100 text-slate-400 hover:text-slate-800 shadow-sm"><Icon name="copy" className="w-4 h-4" /></button>
                                                </div>
                                            </div>
                                            <p className="text-sm text-slate-500 leading-relaxed">{p.prompt}</p>
                                            
                                            {translations[pid] && <div className="mt-4 pt-4 border-t border-slate-50 text-[12px] text-[#0891B2] italic">üáπüá≠ {translations[pid]}</div>}
                                            {sounds[pid] && <div className="mt-3 bg-[#DB2777]/5 p-3 rounded-2xl text-[11px] text-[#DB2777] border-l-2 border-[#DB2777]">üéµ {sounds[pid]}</div>}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
}
